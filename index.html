<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe to Sheets v3.1</title>
    <!-- Version 3.1 - Fixed Apps Script submission method (use form instead of fetch) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #FAF7F2;
            --sage: #8B9D83;
            --forest: #4A5D4A;
            --terracotta: #D4856A;
            --charcoal: #2B2B2B;
            --sand: #E8DFD0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--sand) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, var(--sage) 1px, transparent 1px);
            background-size: 30px 30px;
            opacity: 0.15;
            z-index: 0;
            animation: drift 60s linear infinite;
        }
        
        @keyframes drift {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 3rem;
            max-width: 600px;
            width: 100%;
            position: relative;
            z-index: 1;
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            border-bottom: 3px solid var(--sage);
            padding-bottom: 1.5rem;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--forest);
            margin-bottom: 0.5rem;
            animation: slideDown 0.8s ease-out 0.2s both;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .subtitle {
            color: var(--sage);
            font-size: 0.95rem;
            font-weight: 500;
            animation: slideDown 0.8s ease-out 0.3s both;
        }
        
        .setup-section, .main-section {
            animation: slideUp 0.8s ease-out 0.4s both;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .setup-section {
            background: linear-gradient(135deg, #FFF9F3 0%, #FFF 100%);
            border: 2px solid var(--sand);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .setup-section h2 {
            font-size: 1.2rem;
            color: var(--forest);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .setup-step {
            margin-bottom: 1.5rem;
        }
        
        .setup-step:last-child {
            margin-bottom: 0;
        }
        
        .step-number {
            display: inline-block;
            background: var(--terracotta);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-right: 0.75rem;
        }
        
        .setup-step p {
            display: inline;
            color: var(--charcoal);
            line-height: 1.6;
        }
        
        .code-box {
            background: var(--charcoal);
            color: #A8E6CF;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            margin: 0.75rem 0;
            overflow-x: auto;
            border-left: 4px solid var(--sage);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: var(--forest);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 0.875rem 1.125rem;
            border: 2px solid var(--sand);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Work Sans', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }
        
        input[type="text"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 4px rgba(139, 157, 131, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, var(--sage) 0%, var(--forest) 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Work Sans', sans-serif;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 93, 74, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }
        
        .status.success {
            background: #E8F5E9;
            color: #2E7D32;
            border: 2px solid #81C784;
        }
        
        .status.error {
            background: #FFEBEE;
            color: #C62828;
            border: 2px solid #EF5350;
        }
        
        .status.info {
            background: #E3F2FD;
            color: #1565C0;
            border: 2px solid #64B5F6;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .help-text {
            font-size: 0.85rem;
            color: var(--sage);
            margin-top: 0.5rem;
        }
        
        .auth-btn {
            background: linear-gradient(135deg, var(--terracotta) 0%, #C4745A 100%);
            margin-bottom: 1rem;
        }
        
        .recipe-preview {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--sand);
            animation: slideUp 0.5s ease-out;
        }
        
        .preview-header h2 {
            font-size: 1.3rem;
            color: var(--forest);
            margin-bottom: 1.5rem;
            font-weight: 600;
        }
        
        .preview-info {
            background: linear-gradient(135deg, #FFF9F3 0%, #FFF 100%);
            border: 2px solid var(--sand);
            border-radius: 10px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 2rem;
            justify-content: center;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            display: block;
            font-size: 0.85rem;
            color: var(--sage);
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            display: block;
            font-size: 1.5rem;
            color: var(--forest);
            font-weight: 700;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--terracotta) 0%, #C4745A 100%);
        }
        
        .section-divider {
            margin: 2rem 0 1.5rem;
            text-align: center;
            position: relative;
        }
        
        .section-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--sand), transparent);
        }
        
        .divider-text {
            background: white;
            padding: 0 1rem;
            font-weight: 600;
            color: var(--forest);
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        
        .ingredients-list, .steps-list {
            margin-bottom: 1rem;
        }
        
        .ingredient-headers {
            display: grid;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--sage);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            grid-template-columns: 2fr 1.5fr 2fr 40px;
        }
        
        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 2fr 40px;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .ingredient-row input {
            padding: 0.75rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .ingredient-row input:focus {
            outline: none;
            border-color: var(--sage);
        }
        
        .ingredient-row input::placeholder {
            color: #bbb;
        }
        
        .delete-btn {
            background: #ffebee;
            border: 2px solid #ffcdd2;
            color: #c62828;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            padding: 0;
            width: 40px;
            height: 40px;
        }
        
        .delete-btn:hover {
            background: #ffcdd2;
            transform: scale(1.1);
        }
        
        .step-row {
            display: grid;
            grid-template-columns: 40px 1fr 40px;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }
        
        .step-number-display {
            background: var(--terracotta);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .step-row textarea {
            padding: 0.75rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: 'Work Sans', sans-serif;
            resize: vertical;
            min-height: 60px;
            transition: border-color 0.2s;
        }
        
        .step-row textarea:focus {
            outline: none;
            border-color: var(--sage);
        }
        
        .secondary-btn {
            background: white;
            color: var(--sage);
            border: 2px dashed var(--sage);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            font-family: 'Work Sans', sans-serif;
            margin-bottom: 2rem;
        }
        
        .secondary-btn:hover {
            background: var(--sage);
            color: white;
            border-style: solid;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .nutrition-item {
            background: linear-gradient(135deg, #FFF9F3 0%, #FFF 100%);
            border: 2px solid var(--sand);
            border-radius: 10px;
            padding: 1rem;
            animation: slideIn 0.3s ease-out;
        }
        
        .nutrition-item label {
            display: block;
            font-size: 0.85rem;
            color: var(--sage);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .nutrition-item input {
            width: 100%;
            padding: 0.625rem;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--forest);
            transition: border-color 0.2s;
        }
        
        .nutrition-item input:focus {
            outline: none;
            border-color: var(--sage);
        }
        
        @media (max-width: 640px) {
            .container {
                padding: 2rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .preview-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .ingredient-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .ingredient-row .delete-btn {
                width: 100%;
            }
            
            .step-row {
                grid-template-columns: 30px 1fr 30px;
            }
            
            .ingredient-headers {
                grid-template-columns: 1.5fr 1fr 1.5fr 30px;
                font-size: 0.75rem;
            }
            
            .step-number-display {
                width: 30px;
                height: 30px;
                font-size: 0.85rem;
            }
            
            .nutrition-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç≥ Recipe to Sheets</h1>
            <p class="subtitle">Transform any recipe into your Google Sheets format</p>
        </div>
        
        <div class="setup-section" id="setupSection">
            <h2>üìã One-Time Setup Required</h2>
            
            <div class="setup-step">
                <span class="step-number">1</span>
                <p>Open your Google Sheet and click <strong>Extensions ‚Üí Apps Script</strong></p>
            </div>
            
            <div class="setup-step">
                <span class="step-number">2</span>
                <p>Copy the Google Apps Script code (I'll provide this separately)</p>
            </div>
            
            <div class="setup-step">
                <span class="step-number">3</span>
                <p>Deploy it as a <strong>Web App</strong> (Execute as: Me, Access: Anyone)</p>
            </div>
            
            <div class="setup-step">
                <span class="step-number">4</span>
                <p>Copy the <strong>Web App URL</strong> and paste below:</p>
                <div class="code-box">https://script.google.com/macros/s/.../exec</div>
            </div>
            
            <div class="form-group" style="margin-top: 1.5rem;">
                <label for="webAppUrl">Google Apps Script Web App URL</label>
                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/.../exec">
                <p class="help-text">This URL is saved locally in your browser</p>
            </div>
            
            <button onclick="saveCredentials()" class="auth-btn">üíæ Save URL</button>
        </div>
        
        <div class="main-section hidden" id="mainSection">
            <div class="form-group">
                <label for="recipeUrl">Recipe URL</label>
                <input type="url" id="recipeUrl" placeholder="https://www.allrecipes.com/recipe/...">
                <p class="help-text">Paste any recipe URL from popular cooking websites</p>
            </div>
            
            <button onclick="extractRecipe()" id="extractBtn">
                üîç Extract Recipe
            </button>
            
            <div style="text-align: center; margin: 1.5rem 0; color: var(--sage); font-weight: 600;">
                ‚Äî OR ‚Äî
            </div>
            
            <div class="form-group">
                <label for="recipeText">Paste Recipe Text (if URL doesn't work)</label>
                <textarea id="recipeText" 
                          placeholder="Paste the entire recipe text here including title, ingredients, steps, and nutrition info..."
                          style="min-height: 150px; width: 100%; padding: 0.875rem; border: 2px solid var(--sand); border-radius: 10px; font-family: 'Work Sans', sans-serif; font-size: 0.95rem;"></textarea>
                <p class="help-text">Copy and paste the recipe directly from the website</p>
            </div>
            
            <button onclick="extractFromText()" id="extractTextBtn" class="secondary-btn" style="margin-bottom: 1.5rem;">
                üìã Extract from Pasted Text
            </button>
            
            <div id="status" class="status hidden"></div>
            
            <div class="recipe-preview hidden" id="recipePreview">
                <div class="preview-header">
                    <h2>üìù Review Before Adding</h2>
                </div>
                
                <div class="form-group">
                    <label for="recipeName">Recipe Name (for sheet title)</label>
                    <input type="text" id="recipeName" placeholder="e.g., Classic Chocolate Chip Cookies">
                    <p class="help-text">This will be the name of the new sheet in your document</p>
                </div>
                
                <div class="form-group">
                    <label for="recipeShortName">Short Name (optional)</label>
                    <input type="text" id="recipeShortName" placeholder="e.g., Choc Chip Cookies">
                    <p class="help-text">A shorter version for easier reference</p>
                </div>
                
                <div class="section-divider">
                    <span class="divider-text">ü•ï Ingredients</span>
                </div>
                
                <div class="ingredient-headers">
                    <span>Ingredient</span>
                    <span>Quantity</span>
                    <span>Comments</span>
                    <span></span>
                </div>
                
                <div id="ingredientsList" class="ingredients-list">
                    <!-- Ingredients will be populated here -->
                </div>
                
                <button onclick="addIngredient()" class="secondary-btn">+ Add Ingredient</button>
                
                <div class="section-divider">
                    <span class="divider-text">üë®‚Äçüç≥ Steps</span>
                </div>
                
                <div id="stepsList" class="steps-list">
                    <!-- Steps will be populated here -->
                </div>
                
                <button onclick="addStep()" class="secondary-btn">+ Add Step</button>
                
                <div class="section-divider">
                    <span class="divider-text">üìä Nutrition Facts</span>
                </div>
                
                <div class="nutrition-grid" id="nutritionGrid">
                    <!-- Nutrition info will be populated here -->
                </div>
                
                <button onclick="addToSheets()" id="addBtn" class="add-btn">
                    ‚úÖ Add to Google Sheets
                </button>
            </div>
        </div>
    </div>

    <script>
        // Store extracted recipe data globally
        let currentRecipeData = null;
        
        // Check if credentials are saved on page load
        window.addEventListener('DOMContentLoaded', () => {
            const webAppUrl = localStorage.getItem('googleWebAppUrl');
            
            if (webAppUrl) {
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
            }
        });
        
        function saveCredentials() {
            const webAppUrl = document.getElementById('webAppUrl').value.trim();
            
            if (!webAppUrl) {
                showStatus('Please enter the Web App URL', 'error');
                return;
            }
            
            if (!webAppUrl.includes('script.google.com')) {
                showStatus('This doesn\'t look like a valid Google Apps Script URL', 'error');
                return;
            }
            
            localStorage.setItem('googleWebAppUrl', webAppUrl);
            
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            
            showStatus('Web App URL saved! You\'re ready to extract recipes.', 'success');
        }
        
        function generateShortName(fullName) {
            // Simple logic to create a short name
            const words = fullName.split(' ');
            if (words.length <= 3) return fullName;
            
            // Take first 3-4 words or abbreviate
            return words.slice(0, 3).join(' ');
        }
        
        function renderIngredients() {
            const container = document.getElementById('ingredientsList');
            container.innerHTML = '';
            
            currentRecipeData.ingredients.forEach((ing, index) => {
                const row = document.createElement('div');
                row.className = 'ingredient-row';
                row.innerHTML = `
                    <input type="text" 
                           value="${ing.ingredient}" 
                           placeholder="Ingredient name"
                           onchange="updateIngredient(${index}, 'ingredient', this.value)">
                    <input type="text" 
                           value="${ing.quantity}" 
                           placeholder="Quantity"
                           onchange="updateIngredient(${index}, 'quantity', this.value)">
                    <input type="text" 
                           value="${ing.comments || ''}" 
                           placeholder="Comments (optional)"
                           onchange="updateIngredient(${index}, 'comments', this.value)">
                    <button class="delete-btn" onclick="deleteIngredient(${index})" title="Delete ingredient">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function renderSteps() {
            const container = document.getElementById('stepsList');
            container.innerHTML = '';
            
            currentRecipeData.steps.forEach((step, index) => {
                // Handle both old format (string) and new format (object) - extract instruction only
                const instruction = typeof step === 'string' ? step : step.instruction || '';
                
                const row = document.createElement('div');
                row.className = 'step-row';
                row.innerHTML = `
                    <div class="step-number-display">${index + 1}</div>
                    <textarea placeholder="Step instruction"
                              onchange="updateStepInstruction(${index}, this.value)">${instruction}</textarea>
                    <button class="delete-btn" onclick="deleteStep(${index})" title="Delete step">√ó</button>
                `;
                container.appendChild(row);
            });
        }
        
        function renderNutrition() {
            const container = document.getElementById('nutritionGrid');
            container.innerHTML = '';
            
            if (!currentRecipeData.nutrition) {
                currentRecipeData.nutrition = {
                    servings: "N/A",
                    calories: "N/A",
                    protein: "N/A",
                    carbs: "N/A",
                    fat: "N/A",
                    fiber: "N/A",
                    sugar: "N/A",
                    sodium: "N/A"
                };
            }
            
            const nutritionFields = [
                { key: 'servings', label: 'Servings' },
                { key: 'calories', label: 'Calories' },
                { key: 'protein', label: 'Protein' },
                { key: 'carbs', label: 'Carbohydrates' },
                { key: 'fat', label: 'Total Fat' },
                { key: 'fiber', label: 'Fiber' },
                { key: 'sugar', label: 'Sugar' },
                { key: 'sodium', label: 'Sodium' }
            ];
            
            nutritionFields.forEach(field => {
                const item = document.createElement('div');
                item.className = 'nutrition-item';
                item.innerHTML = `
                    <label>${field.label}</label>
                    <input type="text" 
                           value="${currentRecipeData.nutrition[field.key] || 'N/A'}" 
                           placeholder="N/A"
                           onchange="updateNutrition('${field.key}', this.value)">
                `;
                container.appendChild(item);
            });
        }
        
        function updateNutrition(key, value) {
            currentRecipeData.nutrition[key] = value;
        }
        
        function updateIngredient(index, field, value) {
            currentRecipeData.ingredients[index][field] = value;
        }
        
        function updateStep(index, value) {
            // For backward compatibility
            if (typeof currentRecipeData.steps[index] === 'string') {
                currentRecipeData.steps[index] = value;
            } else {
                currentRecipeData.steps[index].instruction = value;
            }
        }
        
        function updateStepInstruction(index, value) {
            if (typeof currentRecipeData.steps[index] === 'string') {
                currentRecipeData.steps[index] = {
                    instruction: value,
                    ingredients: [],
                    time: ''
                };
            } else {
                currentRecipeData.steps[index].instruction = value;
            }
        }
        
        function updateStepTime(index, value) {
            if (typeof currentRecipeData.steps[index] === 'string') {
                currentRecipeData.steps[index] = {
                    instruction: currentRecipeData.steps[index],
                    ingredients: [],
                    time: value
                };
            } else {
                currentRecipeData.steps[index].time = value;
            }
        }
        
        function updateStepIngredients(index, value) {
            const ingredients = value.split(',').map(i => i.trim()).filter(Boolean);
            if (typeof currentRecipeData.steps[index] === 'string') {
                currentRecipeData.steps[index] = {
                    instruction: currentRecipeData.steps[index],
                    ingredients: ingredients,
                    time: ''
                };
            } else {
                currentRecipeData.steps[index].ingredients = ingredients;
            }
            renderSteps(); // Re-render to show ingredient pills
        }
        
        function deleteIngredient(index) {
            currentRecipeData.ingredients.splice(index, 1);
            renderIngredients();
        }
        
        function deleteStep(index) {
            currentRecipeData.steps.splice(index, 1);
            renderSteps();
        }
        
        function addIngredient() {
            currentRecipeData.ingredients.push({
                ingredient: '',
                quantity: '',
                comments: ''
            });
            renderIngredients();
            // Focus on the new ingredient field
            const inputs = document.querySelectorAll('.ingredient-row input');
            if (inputs.length > 0) {
                inputs[inputs.length - 3].focus();
            }
        }
        
        function addStep() {
            currentRecipeData.steps.push('');
            renderSteps();
            // Focus on the new step textarea
            const textareas = document.querySelectorAll('.step-row textarea');
            if (textareas.length > 0) {
                textareas[textareas.length - 1].focus();
            }
        }
        
        // Make functions globally accessible
        window.extractFromText = async function() {
            const text = document.getElementById('recipeText').value.trim();
            
            if (!text) {
                showStatus('Please paste some recipe text', 'error');
                return;
            }
            
            const btn = document.getElementById('extractTextBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Analyzing text...';
            
            // Hide preview section while extracting
            document.getElementById('recipePreview').classList.add('hidden');
            
            try {
                showStatus('Analyzing recipe text with AI...', 'info');
                const recipeData = await analyzeText(text);
                
                // Store the data globally
                currentRecipeData = recipeData;
                
                // Populate the preview fields
                document.getElementById('recipeName').value = recipeData.title;
                document.getElementById('recipeShortName').value = generateShortName(recipeData.title);
                
                // Render editable ingredients and steps
                renderIngredients();
                renderSteps();
                renderNutrition();
                
                // Show the preview section
                document.getElementById('recipePreview').classList.remove('hidden');
                showStatus('‚úÖ Recipe extracted! Review and edit below, then click "Add to Google Sheets"', 'success');
                
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üìã Extract from Pasted Text';
            }
        }
        
        async function analyzeText(text) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 3000,
                    messages: [{
                        role: 'user',
                        content: `Extract the recipe from this text and return ONLY valid JSON (no markdown, no backticks, no preamble):

{
  "title": "Recipe Name",
  "ingredients": [{"ingredient": "flour", "quantity": "2 cups", "comments": "all-purpose"}],
  "steps": ["Preheat oven to 350¬∞F", "In a bowl, mix 2 cups flour with other ingredients"],
  "nutrition": {"servings": "8", "calories": "250", "protein": "4g", "carbs": "45g", "fat": "8g", "fiber": "2g", "sugar": "20g", "sodium": "150mg"}
}

RULES:
- In steps, include specific quantities when ingredients are used
- Use "N/A" for any nutrition info not found
- Extract exactly as written

Recipe text:
${text}`
                    }]
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'Failed to analyze recipe');
            }
            
            const data = await response.json();
            let textContent = data.content
                .filter(block => block.type === 'text')
                .map(block => block.text)
                .join('');
            
            // Remove markdown code fences if present
            textContent = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            // Extract JSON
            const jsonMatch = textContent.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Could not parse recipe data from the text provided.');
            }
            
            try {
                return JSON.parse(jsonMatch[0]);
            } catch (parseError) {
                throw new Error('Could not parse recipe data. Please check the text format.');
            }
        }
        
        async function extractRecipe() {
            const url = document.getElementById('recipeUrl').value.trim();
            
            if (!url) {
                showStatus('Please enter a recipe URL', 'error');
                return;
            }
            
            const btn = document.getElementById('extractBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Extracting recipe...';
            
            // Hide preview section while extracting
            document.getElementById('recipePreview').classList.add('hidden');
            
            try {
                // Step 1 & 2: Send URL to Claude API to fetch and extract
                showStatus('Fetching and analyzing recipe...', 'info');
                const recipeData = await fetchAndAnalyzeRecipe(url);
                
                // Store the data globally
                currentRecipeData = recipeData;
                
                // Populate the preview fields
                document.getElementById('recipeName').value = recipeData.title;
                document.getElementById('recipeShortName').value = generateShortName(recipeData.title);
                
                // Render editable ingredients and steps
                renderIngredients();
                renderSteps();
                renderNutrition();
                
                // Show the preview section
                document.getElementById('recipePreview').classList.remove('hidden');
                showStatus('‚úÖ Recipe extracted! Review and edit below, then click "Add to Google Sheets"', 'success');
                
            } catch (error) {
                console.error(error);
                showStatus('‚ùå Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'üîç Extract Recipe';
            }
        }
        
        async function addToSheets() {
            if (!currentRecipeData) {
                showStatus('No recipe data to add', 'error');
                return;
            }
            
            const recipeName = document.getElementById('recipeName').value.trim();
            const shortName = document.getElementById('recipeShortName').value.trim();
            
            if (!recipeName) {
                showStatus('Please enter a recipe name', 'error');
                return;
            }
            
            const btn = document.getElementById('addBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Adding to sheet...';
            
            try {
                showStatus('Creating new sheet in your document...', 'info');
                
                // Update the recipe data with the custom names
                currentRecipeData.title = recipeName;
                currentRecipeData.shortName = shortName;
                
                await addToGoogleSheets(currentRecipeData);
                
                showStatus('‚úÖ Recipe successfully added to your Google Sheet!', 'success');
                
                // Reset the form
                document.getElementById('recipeUrl').value = '';
                document.getElementById('recipeText').value = '';
                document.getElementById('recipePreview').classList.add('hidden');
                currentRecipeData = null;
                
            } catch (error) {
                console.error('Full error details:', error);
                let errorMessage = error.message;
                
                // Provide more helpful error messages
                if (errorMessage.includes('API key not valid')) {
                    errorMessage = 'Invalid API key. Please check your Google Sheets API key in settings.';
                } else if (errorMessage.includes('not found')) {
                    errorMessage = 'Sheet not found. Please check your Sheet ID is correct.';
                } else if (errorMessage.includes('permission')) {
                    errorMessage = 'Permission denied. Make sure your sheet is set to "Anyone with link can edit".';
                }
                
                showStatus('‚ùå Error: ' + errorMessage, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚úÖ Add to Google Sheets';
            }
        }
        
        async function fetchAndAnalyzeRecipe(url) {
            // Try multiple CORS proxies as fallbacks
            let html;
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://cors-anywhere.herokuapp.com/${url}`
            ];
            
            let lastError;
            for (const proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`Proxy returned ${response.status}`);
                    }
                    html = await response.text();
                    if (html && html.length > 100) {
                        break; // Successfully fetched
                    }
                } catch (fetchError) {
                    lastError = fetchError;
                    continue; // Try next proxy
                }
            }
            
            if (!html || html.length < 100) {
                throw new Error('Could not access the recipe page through any proxy. The website may be blocking automated access. Try copying the recipe text manually using the "Paste Recipe Text" option below.');
            }
            
            // Now analyze with Claude
            const analysisResponse = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 3000,
                    messages: [{
                        role: 'user',
                        content: `Extract the recipe from this text and return ONLY valid JSON (no markdown, no backticks, no preamble):

{
  "title": "Recipe Name",
  "ingredients": [{"ingredient": "flour", "quantity": "2 cups", "comments": "all-purpose"}],
  "steps": [
    "Preheat oven to 350¬∞F",
    "In a large bowl, mix 2 cups flour with 1 cup sugar"
  ],
  "nutrition": {"servings": "8", "calories": "250", "protein": "4g", "carbs": "45g", "fat": "8g", "fiber": "2g", "sugar": "20g", "sodium": "150mg"}
}

RULES:
- In steps, include specific ingredient quantities when mentioned (e.g., "mix 2 cups flour" not just "mix flour")
- Nutrition should be per serving
- Use "N/A" for any nutrition info not found

Recipe text:
${text}`
                    }]
                })
            });
            
            if (!analysisResponse.ok) {
                const error = await analysisResponse.json();
                throw new Error(error.error?.message || 'Failed to analyze recipe');
            }
            
            const data = await analysisResponse.json();
            let textContent = data.content
                .filter(block => block.type === 'text')
                .map(block => block.text)
                .join('');
            
            // Remove markdown code fences if present
            textContent = textContent.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            // Extract JSON
            const jsonMatch = textContent.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                throw new Error('Could not parse recipe data. The page might not contain a standard recipe format.');
            }
            
            try {
                return JSON.parse(jsonMatch[0]);
            } catch (parseError) {
                throw new Error('Could not parse recipe data. The page format may be unsupported.');
            }
        }
        
        async function addToGoogleSheets(recipeData) {
            const webAppUrl = localStorage.getItem('googleWebAppUrl');
            
            if (!webAppUrl) {
                throw new Error('Web App URL not found. Please set it up in settings.');
            }
            
            console.log('Sending data to Google Apps Script...');
            console.log('Recipe data:', recipeData);
            
            // Create a hidden form to submit data (more reliable than fetch for Apps Script)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = webAppUrl;
            form.target = 'hidden-iframe';
            form.style.display = 'none';
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'data';
            input.value = JSON.stringify(recipeData);
            form.appendChild(input);
            
            // Create hidden iframe for the response
            let iframe = document.getElementById('hidden-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'hidden-iframe';
                iframe.name = 'hidden-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(form);
            }, 1000);
            
            console.log('Data sent successfully!');
            
            // Wait a moment for the server to process
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.remove('hidden');
        }
    </script>
</body>
</html>
